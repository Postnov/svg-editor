<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SVG Editor Pro</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f0f2f5;
      min-height: 100vh;
      color: #1a1a2e;
    }

    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --primary-light: #3b82f6;
      --primary-lighter: #eff6ff;
      --danger: #ef4444;
      --danger-light: #fee2e2;
      --success: #10b981;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --radius: 10px;
      --radius-lg: 14px;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
    }

    /* Main Layout */
    .editor {
      display: grid;
      grid-template-columns: 340px 1fr;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      background: white;
      border-right: 1px solid var(--gray-200);
      padding: 1.5rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .sidebar__header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--gray-100);
    }

    .sidebar__logo {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary-light), var(--primary));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(37,99,235,0.3);
    }

    .sidebar__logo svg {
      width: 20px;
      height: 20px;
      color: white;
    }

    .sidebar__title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--gray-900);
    }

    /* Section */
    .section {
      background: var(--gray-50);
      border-radius: var(--radius);
      padding: 1rem;
    }

    .section__title {
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-500);
      margin-bottom: 0.75rem;
    }

    /* Color Mode Toggle */
    .toggle-group {
      display: flex;
      background: var(--gray-200);
      border-radius: 8px;
      padding: 3px;
      gap: 3px;
    }

    .toggle-btn {
      flex: 1;
      padding: 0.5rem;
      border: none;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
      background: transparent;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.15s;
    }

    .toggle-btn--active {
      background: white;
      color: var(--gray-900);
      box-shadow: var(--shadow-sm);
    }

    /* Recolor Mode Buttons */
    .mode-btns {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.375rem;
    }

    .mode-btn {
      padding: 0.5rem 0.25rem;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      background: white;
      font-size: 0.6875rem;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.15s;
    }

    .mode-btn:hover {
      border-color: var(--primary-light);
      color: var(--primary);
    }

    .mode-btn--active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Color Picker */
    .color-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-top: 0.75rem;
    }

    .color-picker {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: var(--shadow-sm), inset 0 0 0 2px rgba(255,255,255,0.8);
    }

    .color-picker::-webkit-color-swatch-wrapper { padding: 0; }
    .color-picker::-webkit-color-swatch { border: none; border-radius: 8px; }

    .color-input {
      flex: 1;
      padding: 0.625rem 0.75rem;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font-size: 0.8125rem;
      font-family: 'SF Mono', monospace;
      text-transform: uppercase;
    }

    .color-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-lighter);
    }

    /* Palette */
    .palette {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 0.75rem;
    }

    .palette__color {
      width: 26px;
      height: 26px;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.1s;
      box-shadow: var(--shadow-sm);
    }

    .palette__color:hover { transform: scale(1.1); }
    .palette__color--active { border-color: var(--gray-900); }

    .palette__add {
      width: 26px;
      height: 26px;
      border-radius: 6px;
      border: 2px dashed var(--gray-300);
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .palette__add:hover {
      border-color: var(--primary);
      background: var(--primary-lighter);
    }

    .palette__add svg {
      width: 12px;
      height: 12px;
      color: var(--gray-400);
    }

    /* Gradient Controls */
    .gradient-controls { display: none; margin-top: 0.75rem; }
    .gradient-controls.visible { display: block; }

    .gradient-preview {
      height: 32px;
      border-radius: 8px;
      border: 1px solid var(--gray-200);
      margin-bottom: 0.75rem;
    }

    .gradient-stops {
      display: flex;
      gap: 0.5rem;
    }

    .gradient-stop {
      flex: 1;
    }

    .gradient-stop__label {
      font-size: 0.625rem;
      color: var(--gray-500);
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 4px;
      text-align: center;
    }

    .gradient-stop input[type="color"] {
      width: 100%;
      height: 32px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .gradient-stop input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
    .gradient-stop input[type="color"]::-webkit-color-swatch { border: none; border-radius: 6px; }

    .angle-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .angle-row__label {
      font-size: 0.6875rem;
      color: var(--gray-600);
      font-weight: 500;
    }

    .slider {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 4px;
      border-radius: 2px;
      background: var(--gray-200);
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(37,99,235,0.3);
    }

    .input--small {
      width: 50px;
      padding: 0.375rem;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      font-size: 0.75rem;
      text-align: center;
    }

    .input--small:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Transform Buttons */
    .transform-btns {
      display: flex;
      gap: 0.375rem;
    }

    .transform-btn {
      flex: 1;
      height: 38px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .transform-btn svg {
      width: 16px;
      height: 16px;
      color: var(--gray-600);
    }

    .transform-btn:hover {
      border-color: var(--primary);
      background: var(--primary-lighter);
    }

    .transform-btn:hover svg { color: var(--primary); }

    .transform-btn--active {
      background: var(--primary);
      border-color: var(--primary);
    }

    .transform-btn--active svg { color: white; }

    /* Stroke Width */
    .stroke-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Main Content */
    .main {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* Top Bar */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .topbar__left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .filename {
      display: none;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.875rem;
      background: white;
      border-radius: 20px;
      font-size: 0.8125rem;
      color: var(--gray-600);
      border: 1px solid var(--gray-200);
    }

    .filename.visible { display: flex; }

    .filename svg {
      width: 14px;
      height: 14px;
      color: var(--primary);
    }

    .topbar__actions {
      display: flex;
      gap: 0.5rem;
    }

    /* Buttons */
    .btn {
      padding: 0.625rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 0.8125rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.15s;
    }

    .btn svg {
      width: 16px;
      height: 16px;
    }

    .btn--primary {
      background: linear-gradient(135deg, var(--primary-light), var(--primary));
      color: white;
      box-shadow: 0 2px 8px rgba(37,99,235,0.25);
    }

    .btn--primary:hover:not(:disabled) {
      box-shadow: 0 4px 12px rgba(37,99,235,0.35);
      transform: translateY(-1px);
    }

    .btn--secondary {
      background: white;
      color: var(--gray-700);
      border: 1px solid var(--gray-200);
    }

    .btn--secondary:hover:not(:disabled) {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Dropdown Button */
    .dropdown {
      position: relative;
    }

    .dropdown__menu {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      min-width: 140px;
      z-index: 100;
      display: none;
    }

    .dropdown__menu.visible { display: block; }

    .dropdown__item {
      padding: 0.625rem 1rem;
      font-size: 0.8125rem;
      color: var(--gray-700);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .dropdown__item:hover {
      background: var(--gray-50);
    }

    .dropdown__item:first-child { border-radius: 8px 8px 0 0; }
    .dropdown__item:last-child { border-radius: 0 0 8px 8px; }

    .dropdown__item--active {
      background: var(--primary-lighter);
      color: var(--primary);
    }

    .dropdown__item svg {
      width: 14px;
      height: 14px;
      color: var(--primary);
    }

    .dropdown__divider {
      height: 1px;
      background: var(--gray-100);
      margin: 4px 0;
    }

    .dropdown__custom {
      padding: 0.5rem;
    }

    .dropdown__custom input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      font-size: 0.8125rem;
      text-align: center;
    }

    /* Preview Area */
    .preview-area {
      flex: 1;
      background: white;
      border-radius: var(--radius-lg);
      border: 1px solid var(--gray-200);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .preview-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background:
        linear-gradient(45deg, var(--gray-100) 25%, transparent 25%),
        linear-gradient(-45deg, var(--gray-100) 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, var(--gray-100) 75%),
        linear-gradient(-45deg, transparent 75%, var(--gray-100) 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      background-color: white;
      position: relative;
      min-height: 400px;
    }

    .preview {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      padding: 2rem;
    }

    .preview svg {
      max-width: 320px;
      max-height: 320px;
      width: auto;
      height: auto;
      filter: drop-shadow(0 4px 12px rgba(0,0,0,0.1));
    }

    .preview svg *:hover {
      cursor: pointer;
    }

    .preview svg .selected {
      outline: 2px dashed var(--primary) !important;
      outline-offset: 3px;
    }

    .empty-state {
      text-align: center;
      color: var(--gray-400);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 1rem;
      opacity: 0.4;
    }

    .empty-state__text {
      font-size: 0.9375rem;
    }

    /* Upload Zone */
    .upload-zone {
      border: 2px dashed var(--gray-300);
      border-radius: var(--radius);
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--gray-50);
    }

    .upload-zone:hover,
    .upload-zone--dragover {
      border-color: var(--primary);
      background: var(--primary-lighter);
    }

    .upload-zone__icon {
      width: 40px;
      height: 40px;
      margin: 0 auto 0.75rem;
      background: white;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
    }

    .upload-zone__icon svg {
      width: 20px;
      height: 20px;
      color: var(--primary);
    }

    .upload-zone__text {
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    .upload-zone__text strong {
      color: var(--primary);
      font-weight: 600;
    }

    .upload-zone__hint {
      font-size: 0.75rem;
      color: var(--gray-400);
      margin-top: 0.25rem;
    }

    /* Selected Element Panel */
    .selected-panel {
      display: none;
      padding: 1rem;
      background: var(--primary-lighter);
      border-top: 1px solid rgba(37,99,235,0.1);
    }

    .selected-panel.visible { display: block; }

    .selected-panel__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .selected-panel__tag {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--primary);
    }

    .selected-panel__tag code {
      background: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-family: 'SF Mono', monospace;
    }

    .selected-panel__colors {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .selected-panel__picker {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .selected-panel__picker::-webkit-color-swatch-wrapper { padding: 0; }
    .selected-panel__picker::-webkit-color-swatch { border: none; border-radius: 6px; }

    .selected-panel__btn {
      padding: 0.5rem 0.75rem;
      border: none;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }

    .selected-panel__btn svg {
      width: 14px;
      height: 14px;
    }

    .selected-panel__btn--apply {
      background: var(--primary);
      color: white;
    }

    .selected-panel__btn--delete {
      background: var(--danger-light);
      color: var(--danger);
    }

    /* ViewBox visual editing overlay */
    .viewbox-overlay {
      position: absolute;
      pointer-events: none;
      display: none;
      z-index: 10;
      border: 1px dashed var(--primary);
      border-radius: 2px;
    }

    .viewbox-overlay.visible {
      display: block;
    }

    .viewbox-frame {
      position: absolute;
      inset: 0;
      pointer-events: auto;
      cursor: move;
    }

    .viewbox-handle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: var(--primary);
      border: 1px solid white;
      border-radius: 1px;
      pointer-events: auto;
      z-index: 11;
    }

    .viewbox-handle--nw { top: -4px; left: -4px; cursor: nw-resize; }
    .viewbox-handle--ne { top: -4px; right: -4px; cursor: ne-resize; }
    .viewbox-handle--sw { bottom: -4px; left: -4px; cursor: sw-resize; }
    .viewbox-handle--se { bottom: -4px; right: -4px; cursor: se-resize; }

    /* ViewBox inputs in sidebar */
    .viewbox-inputs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
    }

    .viewbox-input {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .viewbox-input label {
      font-size: 0.625rem;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      text-align: center;
    }

    .viewbox-input input {
      width: 100%;
      padding: 0.5rem 0.25rem;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      font-size: 0.75rem;
      text-align: center;
      font-family: 'SF Mono', monospace;
    }

    .viewbox-input input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--primary-lighter);
    }

    .viewbox-toggle {
      width: 100%;
      margin-top: 0.5rem;
      padding: 0.5rem;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      background: white;
      font-size: 0.6875rem;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      transition: all 0.15s;
    }

    .viewbox-toggle svg {
      width: 14px;
      height: 14px;
    }

    .viewbox-toggle:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .viewbox-toggle.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 0.875rem 1.25rem;
      background: var(--gray-900);
      color: white;
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s;
    }

    .toast.visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast svg {
      width: 18px;
      height: 18px;
      color: var(--success);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }

    .modal-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 25px 50px rgba(0,0,0,0.2);
      transform: scale(0.95);
      transition: transform 0.2s;
    }

    .modal-overlay.visible .modal {
      transform: scale(1);
    }

    .modal__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .modal__title {
      font-size: 1rem;
      font-weight: 600;
    }

    .modal__close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--gray-100);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal__close:hover { background: var(--gray-200); }
    .modal__close svg { width: 16px; height: 16px; color: var(--gray-600); }

    .modal__code {
      width: 100%;
      height: 150px;
      padding: 0.75rem;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      font-size: 0.75rem;
      font-family: 'SF Mono', monospace;
      resize: none;
      background: var(--gray-50);
      word-break: break-all;
    }

    .modal__actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 1rem;
    }

    /* File Input */
    .file-input { display: none; }

    /* Responsive */
    @media (max-width: 900px) {
      .editor {
        grid-template-columns: 1fr;
      }
      .sidebar {
        position: fixed;
        left: -100%;
        top: 0;
        bottom: 0;
        width: 320px;
        z-index: 100;
        transition: left 0.3s;
      }
      .sidebar.open { left: 0; }
      .main { padding: 1rem; }
    }
  </style>
</head>
<body>

<div class="editor">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar__header">
      <div class="sidebar__logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
      </div>
      <h1 class="sidebar__title">SVG Editor Pro</h1>
    </div>

    <!-- Upload -->
    <div class="upload-zone" id="upload-zone">
      <div class="upload-zone__icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      </div>
      <div class="upload-zone__text">Перетащите или <strong>выберите SVG</strong></div>
      <div class="upload-zone__hint">.svg файлы</div>
      <input type="file" id="file-input" class="file-input" accept=".svg,image/svg+xml">
    </div>

    <!-- Recolor Mode -->
    <div class="section">
      <div class="section__title">Режим перекраски</div>
      <div class="mode-btns">
        <button class="mode-btn mode-btn--active" data-mode="fill">Fill</button>
        <button class="mode-btn" data-mode="stroke">Stroke</button>
        <button class="mode-btn" data-mode="both">Оба</button>
        <button class="mode-btn" data-mode="all">Всё</button>
      </div>
    </div>

    <!-- Color -->
    <div class="section">
      <div class="section__title">Цвет</div>
      <div class="toggle-group">
        <button class="toggle-btn toggle-btn--active" data-colormode="solid">Сплошной</button>
        <button class="toggle-btn" data-colormode="gradient">Градиент</button>
      </div>

      <!-- Solid Color -->
      <div id="solid-controls">
        <div class="color-row">
          <input type="color" id="color-picker" class="color-picker" value="#2563eb">
          <input type="text" id="color-text" class="color-input" value="#2563EB">
        </div>
        <div class="palette" id="palette">
          <div class="palette__color palette__color--active" style="background:#2563eb" data-color="#2563eb"></div>
          <div class="palette__color" style="background:#7c3aed" data-color="#7c3aed"></div>
          <div class="palette__color" style="background:#db2777" data-color="#db2777"></div>
          <div class="palette__color" style="background:#dc2626" data-color="#dc2626"></div>
          <div class="palette__color" style="background:#ea580c" data-color="#ea580c"></div>
          <div class="palette__color" style="background:#16a34a" data-color="#16a34a"></div>
          <div class="palette__color" style="background:#0891b2" data-color="#0891b2"></div>
          <div class="palette__color" style="background:#1e293b" data-color="#1e293b"></div>
          <button class="palette__add" id="add-color">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
        </div>
      </div>

      <!-- Gradient Controls -->
      <div id="gradient-controls" class="gradient-controls">
        <div class="toggle-group" style="margin-top: 0.5rem;">
          <button class="toggle-btn toggle-btn--active" data-gradtype="linear">Линейный</button>
          <button class="toggle-btn" data-gradtype="radial">Радиальный</button>
        </div>
        <div class="gradient-preview" id="gradient-preview" style="margin-top: 0.75rem;"></div>
        <div class="gradient-stops">
          <div class="gradient-stop">
            <div class="gradient-stop__label">Начало</div>
            <input type="color" id="grad-start" value="#2563eb">
          </div>
          <div class="gradient-stop">
            <div class="gradient-stop__label">Конец</div>
            <input type="color" id="grad-end" value="#7c3aed">
          </div>
        </div>
        <div class="angle-row" id="angle-row">
          <span class="angle-row__label">Угол</span>
          <input type="range" class="slider" id="grad-angle" min="0" max="360" value="135">
          <input type="number" class="input--small" id="grad-angle-val" min="0" max="360" value="135">
        </div>
      </div>
    </div>

    <!-- Transform -->
    <div class="section">
      <div class="section__title">Трансформация</div>
      <div class="transform-btns">
        <button class="transform-btn" id="rotate-left" title="Повернуть влево">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
        </button>
        <button class="transform-btn" id="rotate-right" title="Повернуть вправо">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        </button>
        <button class="transform-btn" id="flip-h" title="Отразить по горизонтали">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h3M16 3h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-3"/><line x1="12" y1="3" x2="12" y2="21"/></svg>
        </button>
        <button class="transform-btn" id="flip-v" title="Отразить по вертикали">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 8V5c0-1.1.9-2 2-2h14a2 2 0 0 1 2 2v3M3 16v3c0 1.1.9 2 2 2h14a2 2 0 0 1 2 2v-3"/><line x1="3" y1="12" x2="21" y2="12"/></svg>
        </button>
      </div>
    </div>

    <!-- Stroke Width -->
    <div class="section">
      <div class="section__title">Толщина обводки</div>
      <div class="stroke-row">
        <input type="range" class="slider" id="stroke-width" min="0" max="10" step="0.5" value="2" style="flex:1;">
        <input type="number" class="input--small" id="stroke-val" min="0" max="20" step="0.5" value="2">
      </div>
    </div>

    <!-- ViewBox -->
    <div class="section">
      <div class="section__title">ViewBox</div>
      <div class="viewbox-inputs">
        <div class="viewbox-input">
          <label>X</label>
          <input type="number" id="vb-x" value="0" step="1">
        </div>
        <div class="viewbox-input">
          <label>Y</label>
          <input type="number" id="vb-y" value="0" step="1">
        </div>
        <div class="viewbox-input">
          <label>W</label>
          <input type="number" id="vb-w" value="24" min="1" step="1">
        </div>
        <div class="viewbox-input">
          <label>H</label>
          <input type="number" id="vb-h" value="24" min="1" step="1">
        </div>
      </div>
      <button class="viewbox-toggle" id="viewbox-edit-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 3v4M3 5h4M6 17v4M4 19h4M13 3l2 2-8 8-2 2v3h3l2-2 8-8 2 2"/></svg>
        Визуальное редактирование
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <!-- Top Bar -->
    <div class="topbar">
      <div class="topbar__left">
        <div class="filename" id="filename">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/><path d="M14 2v6h6"/></svg>
          <span id="filename-text"></span>
        </div>
      </div>
      <div class="topbar__actions">
        <button class="btn btn--secondary" id="copy-btn" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4c0-1.1.9-2 2-2h9a2 2 0 0 1 2 2v1"/></svg>
          Копировать
        </button>
        <button class="btn btn--secondary" id="base64-btn" disabled>Base64</button>
        <button class="btn btn--secondary" id="datauri-btn" disabled>Data URI</button>
        <button class="btn btn--primary" id="download-svg" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          SVG
        </button>
        <div class="dropdown">
          <button class="btn btn--primary" id="download-png" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
            PNG
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;margin-left:2px;"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div class="dropdown__menu" id="png-menu">
            <div class="dropdown__item" data-size="64">64 × 64</div>
            <div class="dropdown__item" data-size="128">128 × 128</div>
            <div class="dropdown__item" data-size="256">256 × 256</div>
            <div class="dropdown__item dropdown__item--active" data-size="512">512 × 512 <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></div>
            <div class="dropdown__item" data-size="1024">1024 × 1024</div>
            <div class="dropdown__item" data-size="2048">2048 × 2048</div>
            <div class="dropdown__divider"></div>
            <div class="dropdown__custom">
              <input type="number" id="png-custom" placeholder="Свой размер" min="16" max="4096">
            </div>
          </div>
        </div>
        <button class="btn btn--secondary" id="reset-btn" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
        </button>
      </div>
    </div>

    <!-- Preview Area -->
    <div class="preview-area">
      <div class="preview-container" id="preview-container">
        <div class="preview" id="preview">
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
            <div class="empty-state__text">Загрузите SVG для редактирования</div>
          </div>
        </div>

        <!-- ViewBox visual editing overlay -->
        <div class="viewbox-overlay" id="viewbox-overlay">
          <div class="viewbox-frame" id="viewbox-frame"></div>
          <div class="viewbox-handle viewbox-handle--nw" data-handle="nw"></div>
          <div class="viewbox-handle viewbox-handle--ne" data-handle="ne"></div>
          <div class="viewbox-handle viewbox-handle--sw" data-handle="sw"></div>
          <div class="viewbox-handle viewbox-handle--se" data-handle="se"></div>
        </div>
      </div>

      <!-- Selected Element Panel -->
      <div class="selected-panel" id="selected-panel">
        <div class="selected-panel__header">
          <span class="selected-panel__tag">Выбран: <code id="selected-tag"></code></span>
        </div>
        <div class="selected-panel__colors">
          <input type="color" id="element-color" class="selected-panel__picker" value="#2563eb">
          <button class="selected-panel__btn selected-panel__btn--apply" id="apply-color">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
            Применить
          </button>
          <button class="selected-panel__btn selected-panel__btn--delete" id="delete-element">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            Удалить
          </button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Toast -->
<div class="toast" id="toast">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
  <span id="toast-text"></span>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal__header">
      <span class="modal__title" id="modal-title">Base64</span>
      <button class="modal__close" id="modal-close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <textarea class="modal__code" id="modal-code" readonly></textarea>
    <div class="modal__actions">
      <button class="btn btn--primary" id="modal-copy">Копировать</button>
    </div>
  </div>
</div>

<script>
(function() {
  // State
  let originalSvg = null;
  let currentSvg = null;
  let filename = 'icon';
  let selectedElement = null;
  let recolorMode = 'fill';
  let colorMode = 'solid';
  let gradientType = 'linear';
  let gradientAngle = 135;
  let rotation = 0;
  let flipH = false;
  let flipV = false;
  let strokeWidth = 2;
  let viewBox = { x: 0, y: 0, w: 24, h: 24 };
  let pngSize = 512;
  let viewBoxEditMode = false;
  let dragData = null;

  // Elements
  const $ = id => document.getElementById(id);
  const uploadZone = $('upload-zone');
  const fileInput = $('file-input');
  const filenameEl = $('filename');
  const filenameText = $('filename-text');
  const preview = $('preview');
  const colorPicker = $('color-picker');
  const colorText = $('color-text');
  const palette = $('palette');
  const gradStart = $('grad-start');
  const gradEnd = $('grad-end');
  const gradAngleSlider = $('grad-angle');
  const gradAngleVal = $('grad-angle-val');
  const gradientPreview = $('gradient-preview');
  const strokeSlider = $('stroke-width');
  const strokeVal = $('stroke-val');
  const selectedPanel = $('selected-panel');
  const selectedTag = $('selected-tag');
  const elementColor = $('element-color');

  // Buttons
  const downloadSvg = $('download-svg');
  const downloadPng = $('download-png');
  const pngMenu = $('png-menu');
  const copyBtn = $('copy-btn');
  const base64Btn = $('base64-btn');
  const datauriBtn = $('datauri-btn');
  const resetBtn = $('reset-btn');

  // Enable/disable buttons
  function setButtonsEnabled(enabled) {
    [downloadSvg, downloadPng, copyBtn, base64Btn, datauriBtn, resetBtn].forEach(btn => {
      btn.disabled = !enabled;
    });
  }

  // Upload handlers
  uploadZone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', e => {
    if (e.target.files[0]) loadFile(e.target.files[0]);
  });

  ['dragenter', 'dragover'].forEach(evt => {
    uploadZone.addEventListener(evt, e => {
      e.preventDefault();
      uploadZone.classList.add('upload-zone--dragover');
    });
  });

  ['dragleave', 'drop'].forEach(evt => {
    uploadZone.addEventListener(evt, e => {
      e.preventDefault();
      uploadZone.classList.remove('upload-zone--dragover');
    });
  });

  uploadZone.addEventListener('drop', e => {
    const file = e.dataTransfer.files[0];
    if (file && file.type === 'image/svg+xml') loadFile(file);
  });

  function loadFile(file) {
    filename = file.name.replace('.svg', '');
    filenameText.textContent = file.name;
    filenameEl.classList.add('visible');

    const reader = new FileReader();
    reader.onload = e => {
      originalSvg = e.target.result;
      initViewBox();
      render();
      setButtonsEnabled(true);
    };
    reader.readAsText(file);
  }

  function initViewBox() {
    const parser = new DOMParser();
    const doc = parser.parseFromString(originalSvg, 'image/svg+xml');
    const svg = doc.querySelector('svg');

    if (svg) {
      let vb = svg.getAttribute('viewBox');
      if (vb) {
        const parts = vb.split(/\s+/).map(Number);
        viewBox = { x: parts[0] || 0, y: parts[1] || 0, w: parts[2] || 24, h: parts[3] || 24 };
      } else {
        const w = parseFloat(svg.getAttribute('width')) || 24;
        const h = parseFloat(svg.getAttribute('height')) || 24;
        viewBox = { x: 0, y: 0, w, h };
      }
      updateViewBoxDisplay();
    }
  }

  // ViewBox input elements
  const vbX = $('vb-x');
  const vbY = $('vb-y');
  const vbW = $('vb-w');
  const vbH = $('vb-h');

  function updateViewBoxDisplay() {
    vbX.value = viewBox.x;
    vbY.value = viewBox.y;
    vbW.value = viewBox.w;
    vbH.value = viewBox.h;
  }

  // ViewBox input handlers
  [vbX, vbY, vbW, vbH].forEach(input => {
    input.addEventListener('input', () => {
      viewBox.x = parseFloat(vbX.value) || 0;
      viewBox.y = parseFloat(vbY.value) || 0;
      viewBox.w = Math.max(1, parseFloat(vbW.value) || 1);
      viewBox.h = Math.max(1, parseFloat(vbH.value) || 1);
      if (originalSvg) render();
    });
  });

  // ViewBox visual editing
  const viewboxOverlay = $('viewbox-overlay');
  const viewboxFrame = $('viewbox-frame');
  const previewContainer = $('preview-container');
  const viewboxEditBtn = $('viewbox-edit-btn');

  function updateViewBoxFrame() {
    if (!originalSvg || !viewBoxEditMode) return;

    const svgEl = preview.querySelector('svg');
    if (!svgEl) return;

    const containerRect = previewContainer.getBoundingClientRect();
    const svgRect = svgEl.getBoundingClientRect();

    viewboxOverlay.style.left = (svgRect.left - containerRect.left) + 'px';
    viewboxOverlay.style.top = (svgRect.top - containerRect.top) + 'px';
    viewboxOverlay.style.width = svgRect.width + 'px';
    viewboxOverlay.style.height = svgRect.height + 'px';
  }

  viewboxEditBtn.addEventListener('click', () => {
    viewBoxEditMode = !viewBoxEditMode;
    viewboxEditBtn.classList.toggle('active', viewBoxEditMode);
    viewboxOverlay.classList.toggle('visible', viewBoxEditMode);
    if (viewBoxEditMode) updateViewBoxFrame();
  });

  // ViewBox drag handlers
  viewboxFrame.addEventListener('mousedown', e => {
    if (!viewBoxEditMode) return;
    dragData = { type: 'move', startX: e.clientX, startY: e.clientY, origViewBox: { ...viewBox } };
    e.preventDefault();
  });

  document.querySelectorAll('.viewbox-handle').forEach(handle => {
    handle.addEventListener('mousedown', e => {
      if (!viewBoxEditMode) return;
      dragData = { type: handle.dataset.handle, startX: e.clientX, startY: e.clientY, origViewBox: { ...viewBox } };
      e.preventDefault();
      e.stopPropagation();
    });
  });

  document.addEventListener('mousemove', e => {
    if (!dragData || !originalSvg) return;

    const svgEl = preview.querySelector('svg');
    if (!svgEl) return;

    const svgRect = svgEl.getBoundingClientRect();
    const scaleX = viewBox.w / svgRect.width;
    const scaleY = viewBox.h / svgRect.height;
    const dx = (e.clientX - dragData.startX) * scaleX;
    const dy = (e.clientY - dragData.startY) * scaleY;
    const orig = dragData.origViewBox;

    switch (dragData.type) {
      case 'move':
        viewBox.x = Math.round((orig.x - dx) * 10) / 10;
        viewBox.y = Math.round((orig.y - dy) * 10) / 10;
        break;
      case 'nw':
        viewBox.x = Math.round((orig.x + dx) * 10) / 10;
        viewBox.y = Math.round((orig.y + dy) * 10) / 10;
        viewBox.w = Math.max(1, Math.round((orig.w - dx) * 10) / 10);
        viewBox.h = Math.max(1, Math.round((orig.h - dy) * 10) / 10);
        break;
      case 'ne':
        viewBox.y = Math.round((orig.y + dy) * 10) / 10;
        viewBox.w = Math.max(1, Math.round((orig.w + dx) * 10) / 10);
        viewBox.h = Math.max(1, Math.round((orig.h - dy) * 10) / 10);
        break;
      case 'sw':
        viewBox.x = Math.round((orig.x + dx) * 10) / 10;
        viewBox.w = Math.max(1, Math.round((orig.w - dx) * 10) / 10);
        viewBox.h = Math.max(1, Math.round((orig.h + dy) * 10) / 10);
        break;
      case 'se':
        viewBox.w = Math.max(1, Math.round((orig.w + dx) * 10) / 10);
        viewBox.h = Math.max(1, Math.round((orig.h + dy) * 10) / 10);
        break;
    }
    render();
  });

  document.addEventListener('mouseup', () => { dragData = null; });
  window.addEventListener('resize', () => { if (viewBoxEditMode) updateViewBoxFrame(); });

  // Render SVG
  function render() {
    if (!originalSvg) return;

    const parser = new DOMParser();
    const doc = parser.parseFromString(originalSvg, 'image/svg+xml');
    const svg = doc.querySelector('svg');

    if (!svg) {
      preview.innerHTML = '<div class="empty-state"><div class="empty-state__text">Ошибка парсинга SVG</div></div>';
      return;
    }

    // Apply viewBox
    svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.w} ${viewBox.h}`);
    svg.removeAttribute('width');
    svg.removeAttribute('height');

    // Determine color
    let color = colorPicker.value;

    if (colorMode === 'gradient') {
      // Remove old gradient defs
      const oldDefs = svg.querySelector('defs#editor-grad-defs');
      if (oldDefs) oldDefs.remove();

      const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      defs.id = 'editor-grad-defs';

      let grad;
      if (gradientType === 'linear') {
        grad = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
        const angle = gradientAngle;
        const rad = (angle - 90) * Math.PI / 180;
        const x1 = 50 + 50 * Math.cos(rad + Math.PI);
        const y1 = 50 + 50 * Math.sin(rad + Math.PI);
        const x2 = 50 + 50 * Math.cos(rad);
        const y2 = 50 + 50 * Math.sin(rad);
        grad.setAttribute('x1', x1 + '%');
        grad.setAttribute('y1', y1 + '%');
        grad.setAttribute('x2', x2 + '%');
        grad.setAttribute('y2', y2 + '%');
      } else {
        grad = document.createElementNS('http://www.w3.org/2000/svg', 'radialGradient');
        grad.setAttribute('cx', '50%');
        grad.setAttribute('cy', '50%');
        grad.setAttribute('r', '50%');
      }

      grad.id = 'editor-grad';

      const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
      stop1.setAttribute('offset', '0%');
      stop1.setAttribute('stop-color', gradStart.value);

      const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
      stop2.setAttribute('offset', '100%');
      stop2.setAttribute('stop-color', gradEnd.value);

      grad.appendChild(stop1);
      grad.appendChild(stop2);
      defs.appendChild(grad);
      svg.insertBefore(defs, svg.firstChild);

      color = 'url(#editor-grad)';
    }

    // Apply color to elements
    const skipTags = ['defs', 'title', 'desc', 'metadata', 'style', 'clipPath', 'mask', 'pattern', 'linearGradient', 'radialGradient', 'stop'];

    svg.querySelectorAll('*').forEach(el => {
      if (skipTags.includes(el.tagName.toLowerCase())) return;

      switch (recolorMode) {
        case 'fill':
          if (el.getAttribute('fill') !== 'none') el.setAttribute('fill', color);
          if (el.style.fill && el.style.fill !== 'none') el.style.fill = color;
          break;
        case 'stroke':
          if (el.getAttribute('stroke') && el.getAttribute('stroke') !== 'none') el.setAttribute('stroke', color);
          if (el.style.stroke && el.style.stroke !== 'none') el.style.stroke = color;
          break;
        case 'both':
          if (el.getAttribute('fill') !== 'none') el.setAttribute('fill', color);
          if (el.getAttribute('stroke') && el.getAttribute('stroke') !== 'none') el.setAttribute('stroke', color);
          break;
        case 'all':
          el.setAttribute('fill', color);
          el.removeAttribute('stroke');
          break;
      }
    });

    if (recolorMode === 'fill' || recolorMode === 'both' || recolorMode === 'all') {
      if (svg.getAttribute('fill') !== 'none') svg.setAttribute('fill', color);
    }

    // Apply stroke width
    svg.querySelectorAll('*').forEach(el => {
      if (el.getAttribute('stroke') && el.getAttribute('stroke') !== 'none') {
        el.setAttribute('stroke-width', strokeWidth);
      }
    });

    // Apply transforms
    if (rotation !== 0 || flipH || flipV) {
      const vb = svg.getAttribute('viewBox').split(/\s+/).map(Number);
      const cx = vb[0] + vb[2] / 2;
      const cy = vb[1] + vb[3] / 2;

      const transforms = [];
      if (rotation !== 0) transforms.push(`rotate(${rotation} ${cx} ${cy})`);
      if (flipH || flipV) {
        transforms.push(`translate(${flipH ? vb[2] + 2*vb[0] : 0} ${flipV ? vb[3] + 2*vb[1] : 0})`);
        transforms.push(`scale(${flipH ? -1 : 1} ${flipV ? -1 : 1})`);
      }

      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      g.setAttribute('transform', transforms.join(' '));
      while (svg.firstChild) g.appendChild(svg.firstChild);
      svg.appendChild(g);
    }

    currentSvg = new XMLSerializer().serializeToString(svg);
    preview.innerHTML = currentSvg;

    setupElementSelection();
    updateViewBoxDisplay();
    requestAnimationFrame(() => { if (viewBoxEditMode) updateViewBoxFrame(); });
  }

  // Element selection
  function setupElementSelection() {
    const svgEl = preview.querySelector('svg');
    if (!svgEl) return;

    const selectables = svgEl.querySelectorAll('path, rect, circle, ellipse, polygon, polyline, line, text, g');

    selectables.forEach(el => {
      el.addEventListener('click', e => {
        e.stopPropagation();

        // Clear previous selection
        svgEl.querySelectorAll('.selected').forEach(s => s.classList.remove('selected'));

        // Select this element
        el.classList.add('selected');
        selectedElement = el;

        // Update panel
        selectedTag.textContent = `<${el.tagName.toLowerCase()}>`;

        // Get current fill color
        const fill = el.getAttribute('fill');
        if (fill && fill !== 'none' && !fill.startsWith('url')) {
          elementColor.value = fill;
        }

        selectedPanel.classList.add('visible');
      });
    });

    // Click outside to deselect
    preview.addEventListener('click', e => {
      if (e.target === preview || e.target === svgEl) {
        clearSelection();
      }
    });
  }

  function clearSelection() {
    const svgEl = preview.querySelector('svg');
    if (svgEl) svgEl.querySelectorAll('.selected').forEach(s => s.classList.remove('selected'));
    selectedElement = null;
    selectedPanel.classList.remove('visible');
  }

  // Apply color to selected element
  $('apply-color').addEventListener('click', () => {
    if (!selectedElement) return;

    const color = elementColor.value;
    selectedElement.setAttribute('fill', color);
    if (selectedElement.getAttribute('stroke') && selectedElement.getAttribute('stroke') !== 'none') {
      selectedElement.setAttribute('stroke', color);
    }

    currentSvg = new XMLSerializer().serializeToString(preview.querySelector('svg'));
    showToast('Цвет применён');
  });

  // Delete selected element
  $('delete-element').addEventListener('click', () => {
    if (!selectedElement) return;

    selectedElement.remove();
    selectedElement = null;
    selectedPanel.classList.remove('visible');

    currentSvg = new XMLSerializer().serializeToString(preview.querySelector('svg'));
    showToast('Элемент удалён');
  });

  // Recolor mode buttons
  document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('mode-btn--active'));
      btn.classList.add('mode-btn--active');
      recolorMode = btn.dataset.mode;
      if (originalSvg) render();
    });
  });

  // Color mode toggle
  document.querySelectorAll('[data-colormode]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('[data-colormode]').forEach(b => b.classList.remove('toggle-btn--active'));
      btn.classList.add('toggle-btn--active');
      colorMode = btn.dataset.colormode;

      $('solid-controls').style.display = colorMode === 'solid' ? 'block' : 'none';
      $('gradient-controls').classList.toggle('visible', colorMode === 'gradient');

      if (colorMode === 'gradient') updateGradientPreview();
      if (originalSvg) render();
    });
  });

  // Gradient type toggle
  document.querySelectorAll('[data-gradtype]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('[data-gradtype]').forEach(b => b.classList.remove('toggle-btn--active'));
      btn.classList.add('toggle-btn--active');
      gradientType = btn.dataset.gradtype;

      $('angle-row').style.display = gradientType === 'linear' ? 'flex' : 'none';
      updateGradientPreview();
      if (originalSvg) render();
    });
  });

  // Color picker sync
  colorPicker.addEventListener('input', () => {
    colorText.value = colorPicker.value.toUpperCase();
    if (originalSvg) render();
  });

  colorText.addEventListener('input', () => {
    if (/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(colorText.value)) {
      colorPicker.value = colorText.value;
      if (originalSvg) render();
    }
  });

  // Palette
  palette.addEventListener('click', e => {
    const colorEl = e.target.closest('.palette__color');
    if (colorEl && colorEl.dataset.color) {
      palette.querySelectorAll('.palette__color').forEach(c => c.classList.remove('palette__color--active'));
      colorEl.classList.add('palette__color--active');

      colorPicker.value = colorEl.dataset.color;
      colorText.value = colorEl.dataset.color.toUpperCase();
      if (originalSvg) render();
    }
  });

  $('add-color').addEventListener('click', () => {
    const color = colorPicker.value;
    if (palette.querySelector(`[data-color="${color}"]`)) {
      showToast('Цвет уже в палитре');
      return;
    }

    const el = document.createElement('div');
    el.className = 'palette__color';
    el.style.background = color;
    el.dataset.color = color;
    palette.insertBefore(el, $('add-color'));
    showToast('Цвет добавлен');
  });

  // Gradient controls
  [gradStart, gradEnd].forEach(input => {
    input.addEventListener('input', () => {
      updateGradientPreview();
      if (originalSvg) render();
    });
  });

  gradAngleSlider.addEventListener('input', () => {
    gradientAngle = parseInt(gradAngleSlider.value);
    gradAngleVal.value = gradientAngle;
    updateGradientPreview();
    if (originalSvg) render();
  });

  gradAngleVal.addEventListener('input', () => {
    gradientAngle = parseInt(gradAngleVal.value) || 0;
    gradAngleSlider.value = gradientAngle;
    updateGradientPreview();
    if (originalSvg) render();
  });

  function updateGradientPreview() {
    if (gradientType === 'linear') {
      gradientPreview.style.background = `linear-gradient(${gradientAngle}deg, ${gradStart.value}, ${gradEnd.value})`;
    } else {
      gradientPreview.style.background = `radial-gradient(circle, ${gradStart.value}, ${gradEnd.value})`;
    }
  }

  updateGradientPreview();

  // Transform buttons
  $('rotate-left').addEventListener('click', () => {
    rotation = (rotation - 90 + 360) % 360;
    if (originalSvg) render();
  });

  $('rotate-right').addEventListener('click', () => {
    rotation = (rotation + 90) % 360;
    if (originalSvg) render();
  });

  $('flip-h').addEventListener('click', function() {
    flipH = !flipH;
    this.classList.toggle('transform-btn--active', flipH);
    if (originalSvg) render();
  });

  $('flip-v').addEventListener('click', function() {
    flipV = !flipV;
    this.classList.toggle('transform-btn--active', flipV);
    if (originalSvg) render();
  });

  // Stroke width
  strokeSlider.addEventListener('input', () => {
    strokeWidth = parseFloat(strokeSlider.value);
    strokeVal.value = strokeWidth;
    if (originalSvg) render();
  });

  strokeVal.addEventListener('input', () => {
    strokeWidth = parseFloat(strokeVal.value) || 0;
    strokeSlider.value = Math.min(strokeWidth, 10);
    if (originalSvg) render();
  });

  // PNG Size Dropdown
  let pngMenuOpen = false;

  downloadPng.addEventListener('click', e => {
    if (downloadPng.disabled) return;

    // If clicking on the main button area
    if (e.target === downloadPng || e.target.closest('svg')) {
      pngMenuOpen = !pngMenuOpen;
      pngMenu.classList.toggle('visible', pngMenuOpen);
    }
  });

  document.addEventListener('click', e => {
    if (!e.target.closest('.dropdown') && pngMenuOpen) {
      pngMenuOpen = false;
      pngMenu.classList.remove('visible');
    }
  });

  pngMenu.addEventListener('click', e => {
    const item = e.target.closest('.dropdown__item');
    if (item && item.dataset.size) {
      pngSize = parseInt(item.dataset.size);

      // Update active state
      pngMenu.querySelectorAll('.dropdown__item').forEach(i => {
        i.classList.remove('dropdown__item--active');
        i.querySelector('svg')?.remove();
      });
      item.classList.add('dropdown__item--active');
      const check = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      check.setAttribute('viewBox', '0 0 24 24');
      check.setAttribute('fill', 'none');
      check.setAttribute('stroke', 'currentColor');
      check.setAttribute('stroke-width', '2');
      check.innerHTML = '<polyline points="20 6 9 17 4 12"/>';
      item.appendChild(check);

      exportPng();
      pngMenuOpen = false;
      pngMenu.classList.remove('visible');
    }
  });

  $('png-custom').addEventListener('keypress', e => {
    if (e.key === 'Enter') {
      const val = parseInt(e.target.value);
      if (val >= 16 && val <= 4096) {
        pngSize = val;
        exportPng();
        pngMenuOpen = false;
        pngMenu.classList.remove('visible');
      }
    }
  });

  function exportPng() {
    const parser = new DOMParser();
    const doc = parser.parseFromString(currentSvg, 'image/svg+xml');
    const svg = doc.querySelector('svg');

    svg.setAttribute('width', pngSize);
    svg.setAttribute('height', pngSize);

    const svgData = new XMLSerializer().serializeToString(svg);
    const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(svgBlob);

    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = pngSize;
      canvas.height = pngSize;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, pngSize, pngSize);

      canvas.toBlob(blob => {
        downloadBlob(blob, `${filename}-${pngSize}px.png`);
        URL.revokeObjectURL(url);
      }, 'image/png');
    };
    img.src = url;
  }

  // Download SVG
  downloadSvg.addEventListener('click', () => {
    const blob = new Blob([currentSvg], { type: 'image/svg+xml' });
    downloadBlob(blob, `${filename}-edited.svg`);
  });

  // Copy SVG
  copyBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(currentSvg);
      showToast('SVG скопирован');
    } catch {
      const ta = document.createElement('textarea');
      ta.value = currentSvg;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      showToast('SVG скопирован');
    }
  });

  // Base64 / Data URI
  base64Btn.addEventListener('click', () => {
    const base64 = btoa(unescape(encodeURIComponent(currentSvg)));
    showModal('Base64', base64);
  });

  datauriBtn.addEventListener('click', () => {
    const base64 = btoa(unescape(encodeURIComponent(currentSvg)));
    showModal('Data URI', `data:image/svg+xml;base64,${base64}`);
  });

  // Reset
  resetBtn.addEventListener('click', () => {
    rotation = 0;
    flipH = false;
    flipV = false;
    strokeWidth = 2;
    $('flip-h').classList.remove('transform-btn--active');
    $('flip-v').classList.remove('transform-btn--active');
    strokeSlider.value = 2;
    strokeVal.value = 2;
    initViewBox();
    render();
    showToast('Сброшено');
  });

  // Toast
  function showToast(text) {
    const toast = $('toast');
    $('toast-text').textContent = text;
    toast.classList.add('visible');
    setTimeout(() => toast.classList.remove('visible'), 2500);
  }

  // Modal
  function showModal(title, code) {
    $('modal-title').textContent = title;
    $('modal-code').value = code;
    $('modal').classList.add('visible');
  }

  $('modal-close').addEventListener('click', () => $('modal').classList.remove('visible'));
  $('modal').addEventListener('click', e => {
    if (e.target === $('modal')) $('modal').classList.remove('visible');
  });

  $('modal-copy').addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText($('modal-code').value);
      showToast('Скопировано');
      $('modal').classList.remove('visible');
    } catch {
      $('modal-code').select();
      document.execCommand('copy');
      showToast('Скопировано');
      $('modal').classList.remove('visible');
    }
  });

  // Helpers
  function downloadBlob(blob, name) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
})();
</script>
</body>
</html>
